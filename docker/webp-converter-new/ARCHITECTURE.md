# Архитектура WebP Converter Service

## Схема работы

```
┌─────────────────────────────────────────────────────────────────┐
│                    Bitrix CDN Server                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────┐   │
│  │   Bitrix    │───▶│   SSHFS      │───▶│  resize_cache/  │   │
│  │   Server    │    │  (mount)     │    │  (NFS share)    │   │
│  └─────────────┘    └──────────────┘    └─────────────────┘   │
│                                      │                        │
│                                      ▼                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              WebP Converter Service                     │   │
│  │                                                         │   │
│  │  ┌──────────┐  ┌─────────────┐  ┌──────────────────┐   │   │
│  │  │ Watcher  │─▶│ Queue Mgr   │─▶│ Image Converter  │   │   │
│  │  │(watchdog)│  │(asyncio)    │  │   (Pillow)       │   │   │
│  │  └──────────┘  └─────────────┘  └──────────────────┘   │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │   │
│  │  │ Prometheus  │  │ Health      │  │ Metrics         │ │   │
│  │  │ :9101       │  │ :8088       │  │ :9101           │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                      │                        │
│                                      ▼                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Файловая система                           │   │
│  │                                                         │   │
│  │  /var/www/cdn/upload/resize_cache/                     │   │
│  │  ├── image.jpg          (оригинал)                     │   │
│  │  ├── image.jpg.webp     (WebP версия)                  │   │
│  │  ├── photo.png          (оригинал)                     │   │
│  │  └── photo.png.webp     (WebP версия)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐   │
│  │   Redis     │    │ Prometheus  │    │    Grafana      │   │
│  │   :6379     │    │   :9090     │    │     :3000       │   │
│  └─────────────┘    └─────────────┘    └─────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

1. **Обнаружение файлов:**
   - `FileWatcher` отслеживает `/var/www/cdn/upload/resize_cache/`
   - При появлении `.jpg`, `.jpeg`, `.png` файлов добавляет в очередь

2. **Обработка очереди:**
   - `QueueManager` управляет очередью с rate limiting
   - Worker'ы берут файлы из очереди

3. **Конвертация:**
   - `ImageConverter` конвертирует изображения в WebP
   - Сохраняет рядом с оригиналом: `file.jpg` → `file.jpg.webp`

4. **Мониторинг:**
   - Prometheus собирает метрики
   - Grafana визуализирует данные
   - Redis кеширует метаданные

## Где сохраняются WebP файлы

**Путь:** `/var/www/cdn/upload/resize_cache/`

**Правило именования:**
- Оригинал: `image.jpg`
- WebP: `image.jpg.webp`

**Права доступа:**
- Владелец: `www-data:www-data` (UID:33, GID:33)
- Права: `644`

## Redis использование

Redis используется для:
- Кеширования метаданных изображений
- Хранения статистики конвертации
- Rate limiting данных
- Мониторинга очереди

**Конфигурация Redis:**
- Порт: `6379`
- Память: `512MB`
- Политика: `allkeys-lru`
- Персистентность: `appendonly yes`
