# Static Files Optimization - ULTRA FAST TTFB
# Author: Chibilyaev Alexandr <info@aachibilyaev.com>

# Direct static file serving for maximum speed
location ~* \.(jpg|jpeg|png|gif|bmp|webp|avif|css|js|ico|svg|woff|woff2|ttf|eot)$ {
    # ULTRA FAST settings
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000";
    add_header Vary "Accept";
    add_header Last-Modified $date_gmt;
    add_header ETag off;
    
    # CORS headers
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    add_header Access-Control-Max-Age 31536000;
    
    # No logging for static files
    access_log off;
    
    # Direct file serving - NO PROXY
    try_files $uri =404;
    
    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
}

# Smart WebP/AVIF serving - ULTRA FAST
location ~* ^/upload/resize_cache/.*\.(jpg|jpeg|png|gif|bmp)$ {
    # Rate limiting
    limit_req zone=images burst=2000 nodelay;
    
    # ULTRA FAST PROXY CACHE
    proxy_cache ram_cache;
    proxy_cache_valid 200 1y;
    proxy_cache_valid 404 1m;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    proxy_cache_lock on;
    proxy_cache_key $scheme$proxy_host$request_uri;
    
    # FAST CACHE HEADERS
    add_header X-Cache-Status $upstream_cache_status;
    add_header Cache-Control "public, immutable, max-age=31536000";
    add_header Vary "Accept";
    add_header Last-Modified $date_gmt;
    add_header ETag off;
    
    # CORS headers
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    add_header Access-Control-Max-Age 31536000;

    # SMART AVIF/WebP serving logic - ULTRA FAST
    # Try AVIF first if browser supports it, then WebP, then original
    try_files $uri$avif_suffix $uri$webp_suffix $uri =404;
    
    # Set correct content type
    add_header Content-Type $image_content_type;
}
