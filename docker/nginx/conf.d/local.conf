server {
    listen 80;
    server_name localhost 127.0.0.1;
    
    # Root directory
    root /mnt/bitrix;
    
    # Logging
    access_log /var/log/nginx/cdn.access.log main;
    error_log /var/log/nginx/cdn.error.log warn;

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK\n";
    }

    # Status page for monitoring
    location /nginx_status {
        stub_status;
        allow all;
    }

    # Handle resize_cache images - stored locally on CDN with async WebP conversion
    location ~ ^/upload/resize_cache/.*\.(jpg|jpeg|png|gif|bmp)$ {
        root /var/www/cdn;

        # Rate limiting
        limit_req zone=images burst=50 nodelay;

        # Cache headers
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-CDN "Bitrix CDN - resize_cache (async)" always;
        add_header Vary "Accept" always;

        # SMART WebP/AVIF serving logic
        # 1. Check AVIF support first
        if ($http_accept ~* "image/avif") {
            try_files $uri.avif $uri =404;
            break;
        }
        
        # 2. Check WebP support
        if ($http_accept ~* "image/webp") {
            try_files $uri.webp $uri =404;
            break;
        }
        
        # 3. Fallback to original
        try_files $uri =404;
    }

    # WebP обработка для изображений из SSHFS
    location ~* ^/upload/.*\.(jpg|jpeg|png|gif|bmp)$ {
        expires 1y;
        add_header Cache-Control "public";
        add_header X-CDN "Bitrix CDN Test - sshfs";
        add_header Vary "Accept";

        # SMART WebP/AVIF serving logic for SSHFS
        # 1. Check AVIF support first
        if ($http_accept ~* "image/avif") {
            try_files /var/cache/webp$uri.avif /mnt/bitrix$uri =404;
            break;
        }
        
        # 2. Check WebP support
        if ($http_accept ~* "image/webp") {
            try_files /var/cache/webp$uri.webp /mnt/bitrix$uri =404;
            break;
        }
        
        # 3. Fallback to original
        try_files /mnt/bitrix$uri =404;
    }

    # Default location
    location / {
        try_files $uri $uri/ =404;
        autoindex on;  # Enable directory listing for testing
    }
}