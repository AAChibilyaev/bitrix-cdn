server {
    listen 80;
    server_name localhost 127.0.0.1;
    
    # Root directory
    root /mnt/bitrix;
    
    # Logging
    access_log /var/log/nginx/cdn.access.log main;
    error_log /var/log/nginx/cdn.error.log warn;

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK\n";
    }

    # Status page for monitoring
    location /nginx_status {
        stub_status;
        allow all;
    }

    # WebP обработка для изображений (nginx.org best practices)
    location ~* \.(jpg|jpeg|png|gif|bmp)$ {
        expires 1y;
        add_header Cache-Control "public";
        add_header X-CDN "Bitrix CDN Test";
        add_header Vary "Accept";
        
        # ИСПРАВЛЕНО: Используем map переменную $webp_suffix из nginx.conf
        # Пробуем WebP версию, затем оригинал
        try_files /var/cache/webp$uri$webp_suffix /mnt/bitrix$uri =404;
    }

    # Default location
    location / {
        try_files $uri $uri/ =404;
        autoindex on;  # Enable directory listing for testing
    }
}