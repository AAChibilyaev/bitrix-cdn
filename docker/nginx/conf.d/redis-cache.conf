# Redis Cache Integration for Nginx
# Author: Chibilyaev Alexandr <info@aachibilyaev.com>

# Redis upstream for caching
upstream redis_backend {
    server redis:6379;
    keepalive 32;
}

# Redis cache key generation
map $request_uri $redis_key {
    default $request_uri;
    "~*\.(jpg|jpeg|png|gif|bmp|webp|avif)$" "img:$request_uri";
}

# Cache status headers
map $upstream_cache_status $cache_status {
    "HIT" "HIT";
    "MISS" "MISS";
    "EXPIRED" "EXPIRED";
    "STALE" "STALE";
    "UPDATING" "UPDATING";
    "REVALIDATED" "REVALIDATED";
    "BYPASS" "BYPASS";
    default "UNKNOWN";
}

# Cache bypass conditions
map $request_method $cache_bypass {
    default 0;
    "POST" 1;
    "PUT" 1;
    "DELETE" 1;
    "PATCH" 1;
}

# Cache control based on file type
map $uri $cache_control {
    default "public, max-age=3600";
    "~*\.(jpg|jpeg|png|gif|bmp|webp|avif)$" "public, immutable, max-age=31536000";
    "~*\.(css|js|html|xml|txt|ico|svg|woff|woff2|ttf|eot)$" "public, immutable, max-age=31536000";
}
